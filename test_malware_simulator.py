"""
Safe Malware Simulator for ORBIT Testing

This script simulates suspicious process behavior patterns to test
ORBIT's detection and monitoring capabilities. It is completely safe
and performs no harmful actions.

Usage: python test_malware_simulator.py
"""

import subprocess
import time
import random
import os
import sys


class MalwareSimulator:
    """Simulates various suspicious process behaviors safely"""
    
    def __init__(self):
        self.running = True
        print("[SIMULATOR] Safe Malware Simulator Started")
        print("[SIMULATOR] This script only simulates suspicious patterns - it's completely safe!")
        print("[SIMULATOR] Press Ctrl+C to stop\n")
    
    def spawn_suspicious_processes(self):
        """Spawn multiple short-lived processes (simulates process injection attempts)"""
        print("[BEHAVIOR] Spawning multiple short-lived processes...")
        
        processes = []
        for i in range(5):
            try:
                # Spawn harmless cmd/powershell processes that exit immediately
                if random.choice([True, False]):
                    proc = subprocess.Popen(
                        ["cmd.exe", "/c", "echo Simulated suspicious activity"],
                        stdout=subprocess.PIPE,
                        stderr=subprocess.PIPE,
                        creationflags=subprocess.CREATE_NO_WINDOW
                    )
                else:
                    proc = subprocess.Popen(
                        ["powershell.exe", "-Command", "Write-Host 'Simulated suspicious activity'"],
                        stdout=subprocess.PIPE,
                        stderr=subprocess.PIPE,
                        creationflags=subprocess.CREATE_NO_WINDOW
                    )
                processes.append(proc)
                print(f"  [+] Spawned process PID: {proc.pid}")
                time.sleep(0.5)
            except Exception as e:
                print(f"  [-] Failed to spawn process: {e}")
        
        # Wait for all to complete
        for proc in processes:
            proc.wait()
        
        print(f"  [âœ“] All {len(processes)} processes terminated\n")
    
    def simulate_wmic_enumeration(self):
        """Simulate WMIC enumeration (common reconnaissance technique)"""
        print("[BEHAVIOR] Simulating WMIC system enumeration...")
        
        wmic_commands = [
            "wmic os get caption",
            "wmic computersystem get domain",
            "wmic process list brief"
        ]
        
        for cmd in wmic_commands:
            try:
                print(f"  [+] Running: {cmd}")
                proc = subprocess.Popen(
                    cmd.split(),
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    creationflags=subprocess.CREATE_NO_WINDOW
                )
                proc.wait(timeout=3)
                print(f"  [âœ“] WMIC command completed (PID: {proc.pid})")
                time.sleep(1)
            except Exception as e:
                print(f"  [-] WMIC command failed: {e}")
        
        print()
    
    def simulate_powershell_activity(self):
        """Simulate suspicious PowerShell activity"""
        print("[BEHAVIOR] Simulating PowerShell suspicious activity...")
        
        ps_commands = [
            "Get-Process | Select-Object -First 5",
            "Get-ComputerInfo | Select-Object -First 3",
            "Get-NetAdapter | Select-Object -First 2"
        ]
        
        for cmd in ps_commands:
            try:
                print(f"  [+] PowerShell: {cmd[:50]}...")
                proc = subprocess.Popen(
                    ["powershell.exe", "-Command", cmd],
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    creationflags=subprocess.CREATE_NO_WINDOW
                )
                proc.wait(timeout=5)
                print(f"  [âœ“] PowerShell completed (PID: {proc.pid})")
                time.sleep(1)
            except Exception as e:
                print(f"  [-] PowerShell command failed: {e}")
        
        print()
    
    def simulate_rapid_process_churn(self):
        """Simulate rapid process creation/termination (evasion technique)"""
        print("[BEHAVIOR] Simulating rapid process churn (evasion simulation)...")
        
        for i in range(10):
            try:
                proc = subprocess.Popen(
                    ["cmd.exe", "/c", "exit"],
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    creationflags=subprocess.CREATE_NO_WINDOW
                )
                print(f"  [+] Rapid spawn #{i+1} (PID: {proc.pid})")
                proc.wait()
                time.sleep(0.2)
            except Exception as e:
                print(f"  [-] Spawn failed: {e}")
        
        print(f"  [âœ“] Rapid churn complete\n")
    
    def simulate_malware_process(self):
        """Simulate malware-level threat by creating process with suspicious name"""
        print("[BEHAVIOR] Simulating MALWARE-LEVEL threat (high-risk process)...")
        
        import tempfile
        import shutil
        
        malware_names = [
            "unknown_service.exe",
            "suspicious_activity.exe", 
            "trojan_loader.exe",
            "malicious_script.exe"
        ]
        
        selected_name = random.choice(malware_names)
        
        try:
            # Create a copy of cmd.exe with a malicious name
            # This way psutil will see the actual malicious name
            temp_dir = tempfile.gettempdir()
            malware_path = os.path.join(temp_dir, selected_name)
            
            # Copy cmd.exe to the malicious name
            shutil.copy(r"C:\Windows\System32\cmd.exe", malware_path)
            
            print(f"  [+] Created malicious-named executable: {selected_name}")
            
            # Execute it with a harmless command that exits after 3 seconds
            proc = subprocess.Popen(
                [malware_path, "/c", "timeout /t 3 /nobreak >nul"],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                creationflags=subprocess.CREATE_NO_WINDOW
            )
            
            print(f"  [ğŸ”´] MALWARE PROCESS SPAWNED (PID: {proc.pid})")
            print(f"  [!] This should trigger a RED ALERT in ORBIT!")
            print(f"  [!] Process name: {selected_name}")
            
            # Wait for completion
            proc.wait(timeout=5)
            
            # Clean up
            try:
                os.remove(malware_path)
                print(f"  [âœ“] Cleaned up {selected_name}")
            except Exception as cleanup_error:
                print(f"  [!] Cleanup warning: {cleanup_error}")
            
            print(f"  [âœ“] Malware simulation complete\n")
            
        except Exception as e:
            print(f"  [-] Malware simulation failed: {e}\n")

    
    def run_simulation(self):
        """Run the full simulation cycle"""
        try:
            cycle = 1
            while self.running:
                print(f"{'='*60}")
                print(f"SIMULATION CYCLE #{cycle}")
                print(f"{'='*60}\n")
                
                # Always include malware simulation for testing
                behaviors = [
                    self.spawn_suspicious_processes,
                    self.simulate_wmic_enumeration,
                    self.simulate_powershell_activity,
                    self.simulate_rapid_process_churn,
                ]
                
                # Execute 2-3 random behaviors PLUS always do malware
                selected = random.sample(behaviors, k=random.randint(2, 3))
                selected.append(self.simulate_malware_process)  # Always include malware
                
                for behavior in selected:
                    behavior()
                    time.sleep(2)
                
                print(f"[SIMULATOR] Cycle #{cycle} complete. Waiting 10 seconds...\n")
                time.sleep(10)
                cycle += 1
                
        except KeyboardInterrupt:
            print("\n\n[SIMULATOR] Stopping simulation...")
            self.running = False


def main():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ORBIT Safe Malware Behavior Simulator               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This script simulates suspicious process behaviors for testing:
  â€¢ Multiple process spawning (process injection simulation)
  â€¢ WMIC enumeration (reconnaissance simulation)
  â€¢ PowerShell activity (script-based attack simulation)
  â€¢ Rapid process churn (evasion technique simulation)
  â€¢ Malware-level threats (high-risk process simulation) ğŸ”´ NEW!

âš ï¸  IMPORTANT: This is a SAFE simulator - no actual malware!
âœ“  All processes are harmless system commands
âœ“  No files are modified or created (except temp test files)
âœ“  No network connections are made
âœ“  No persistence mechanisms are installed

Watch ORBIT's dashboard to see these processes being detected!

ğŸŸ¡ Yellow Alerts = Suspicious (powershell, cmd, wmic)
ğŸ”´ Red Alerts = Malware (processes with suspicious names)
""")
    
    input("Press ENTER to start simulation...")
    print()
    
    simulator = MalwareSimulator()
    simulator.run_simulation()
    
    print("[SIMULATOR] Simulation stopped. Goodbye!")


if __name__ == "__main__":
    main()
